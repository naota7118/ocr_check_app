# 紙データの照合アプリ「OCR Check」
![トップページ](https://github.com/user-attachments/assets/2f007153-77e6-4e00-afa4-6814d645da81)

アプリURL：https://ocrcheck.com/  

本アプリは閲覧可能ですが、照合機能は使用不可とさせて頂いております。  
理由としましては、本アプリは社内向けに作ったものであり、照合に使うデータの外部への公開をできるだけ控えたいためです。  
面接でデモをお見せすることはできます。

## 概要
わたしは治験の検査員を行っています。
![わたしの仕事](https://github.com/user-attachments/assets/cb20697f-64f1-4fbf-9b29-69f567e5290e)
認知機能検査の採点および入力（手書き）を行う業務があります。

その業務において、紙データとエクセルデータの照合に時間がかかる問題を抱えていました。

そこで、OCR技術を活用して、照合作業を効率化するアプリ「OCR Check」を開発しました。

## どんな課題を解決するのか？
現状で以下3つの課題があります。
![現状どのような課題がある？](https://github.com/user-attachments/assets/e800f53c-eda7-40ff-b7dd-8cba4e33888c)
 
1ヶ月あたり190人、5ヶ月で合計およそ1,000人分のデータを2人体制でチェックしていました。  

不一致の見落としがないように注意深く確認していましたが、それでもひと月200件のうち3〜4件ほど見落としがありました。

**「どんなに注意してやっても、人力だと見落としが発生してしまう。自動化すれば見落としを防げるし、効率化できるのはないか？」**
と考え、照合作業を自動化する方法を調べ始めました。

職場の上司への事前ヒアリングやユーザーインタビューの内容は、こちらの記事で詳しく解説しています。

[OCR Check事前ヒアリング・ユーザーインタビュー・技術を選んだ理由](https://qiita.com/naota7118/private/1790c44202a52e992170)

## 業務の流れ
業務の流れを順を追って説明します。
![検査実施からエクセル入力までの流れ](https://github.com/user-attachments/assets/c141e257-d00e-4ce0-9e14-14e9557bab6b)
まず、被験者様と検査者によって検査が行われます。  
検査が終わった時点では、得点は記入されていません。  

いきなり検査用紙に得点を記入してしまうと、得点が間違っていた場合に何度も修正した跡が残ってしまうため、検査用紙を印刷します。  
検査用紙のコピーと原本が採点チームに渡されます。  

採点業務は、まず1人目が採点を行い、検査用紙のコピーに得点を記入します。  
その後、2人目と3人目が採点を行います。  
3人の得点が一致したらエクセル表に得点を入力します。

![検査用紙の原本に得点を記入するまでの流れ](https://github.com/user-attachments/assets/7fe21aa8-f6d9-4cc8-9f47-ae2d1ada0dcf)
その後、検査用紙コピーに記入された得点とエクセルに入力された得点が一致しているかを確認し、一致していたら原本に転記します。

![なぜエクセルに入力して照合するのか？](https://github.com/user-attachments/assets/7c7d0b70-c63f-4dbd-a81d-897bc085edff)
「エクセルに入力して検査用紙コピーと照合する」手順を踏む理由は、原本の正確性を担保するためです。
  
![現状どのように照合しているか](https://github.com/user-attachments/assets/2837a912-bdbc-4f8f-b2c7-d039aa0219ee)
現状では、①検査用紙のコピーと②エクセルを印刷した紙を見比べて、一致しているか確認しています。  
一致していなかったら間違っているほうの得点を修正します。
  
![エクセル得点表を印刷した紙のサンプル](https://github.com/user-attachments/assets/8b1e7fee-3792-4cf2-9ae9-719c68362f21)
このように、一致していたらマーカーやチェックを入れて照合の結果を残していました。  
  
## アプリを使った結果どうなるか？
![OCR Checkで照合作業はどう変わる？](https://github.com/user-attachments/assets/446fb42d-6e0e-4be4-bca0-8ab3f05ab1e7)

## 【10/18追記】エクセルへの書き出しも自動化
9月24日に上司にユーザーインタビューを行い「エクセルに転記することもできるの？」と聞かれました。  
そこで、エクセルへの転記作業も自動化しました。  
現在は、PDFをアップロードすればエクセルへの転記が行われ、そのうえでPDFとエクセルの照合が行われるようにしています。

関連記事：[Excelへの書き出し部分のリファクタリング](https://qiita.com/naota7118/items/797ae99764e5120469a7)

## 【10/18追記】導入に至っていない理由
現状ではGoogle Drive APIを使用しており、インターネットにつなぐ必要があるため、情報流出の懸念があり導入に至っておりません。  
10/22に上司と話し合う時間を頂いており、そこで会社のセキュリティポリシを確認したり、リスクの洗い出しを行う予定です。

## 説明動画
動画で実際にどのように照合処理が行われているか説明しています。  
下の画像をクリックしていただくと、YouTube動画が再生されます。  

※動画では検査データにモザイク処理がかかっており内容がわかりにくいですが、デモではサンプルデータを使ってモザイクなしでお見せします。

※2倍速での視聴をおすすめします。（音量が小さい場合は誠にお手数ですが大きくして頂けますと幸いです）

[![OCR Check動画サムネイル (1)](https://github.com/user-attachments/assets/de807982-d870-4080-9286-2c11e7c2dfa7)](https://www.youtube.com/watch?v=8EbsyVoQ1HA)

### 照合結果画面
修正すべき不一致の件数と修正箇所が一目でわかります。
<img width="1256" alt="スクリーンショット 2024-09-15 午後8 42 11" src="https://github.com/user-attachments/assets/a9f2b629-d0df-4a93-918d-01f49756adef">

## 工夫したところ
![工夫したところ1](https://github.com/user-attachments/assets/a73cf884-322c-4196-8f23-cd496ca7d347)
検査用紙データから得点データを抽出するところで、抽出したい数値のみを抽出できず、何度もコードを書き直しました。  
- /の後ろが1ケタの数値のときは/の直前の数値を取得
- /の後ろが30のときは/の直前とその前の値を取得

上記を実行するために、pメソッドで出力結果を確認しながらコードを修正していきました。

![検査用紙から得点データを抽出する流れ](https://github.com/user-attachments/assets/5c62996a-58c8-4ce6-acc2-6bbaeac05bb7)
Google Drive APIのOCR技術によって、PDFファイルの中のテキストデータのみがテキストファイルに出力されます。  
その中から得点データのみ抽出し、被験者ごとの配列に格納して照合するメソッドに渡すようにしました。
  
![工夫したところ2-1](https://github.com/user-attachments/assets/c01192d7-35ea-4949-8ddc-136e37db97c1)
①検査用紙の得点と②エクセルの得点をそれぞれ被験者ごとの配列に格納して比較しようと考えました。  
  
エクセルデータはRooライブラリを使って行ごとの配列に区切ることができましたが、検査用紙データは自分で設定する必要があったので、検査項目数で区切りました。

![工夫したところ2-2](https://github.com/user-attachments/assets/2c21e64b-3baa-4603-9500-1c15037c26f4)
最終的に照合結果をどのように表示させるのがいいか悩みましたが、「被験者ごとに表形式で表示する」と決めたことで、`[検査用紙データ, エクセルデータ, 照合結果]`の形で出力することにしました。

## 使用した技術
- バックエンド
  - Ruby 3.3.0
  - Ruby on Rails 7.1.3.2
  - Apache(プロキシサーバー化)
  - Rubocop
  - Rspec
- フロントエンド
  - HTML/CSS
  - JavaScript  
    一致しなかった項目に色をつける処理を実装しました。
- インフラ
  - Docker
  - AWS(EC2, VPC, Route53, ACM, ALB, WAF)
  - GitHub Actions CI/CDを自動化
- ライブラリ
  - google/apis/drive_v3  
    PDFからテキストデータを抽出するために使いました。  
    具体的には、PDFをGoogleドキュメント形式に変換し、Googleドキュメントからテキストファイルを出力することで、テキスト部分のみ抽出しています。
  - google/api_client/client_secrets  
    Google Drive APIのOCRを活用するにはGoogle認証を通す必要がありました。
  - roo  
    フォーム送信したエクセルデータから照合に必要な得点データを取得するために使いました。指定した列の値のみ配列に格納するようにしました。
  - high_voltage  
    トップページを表示するために使いました。静的なページをコントローラを作らず表示できないか調べていて見つけました。

## インフラ構成図
![ocrcheck_infra](https://github.com/user-attachments/assets/403c1d0d-68b3-44a7-91a1-ebcc806b55f4)
